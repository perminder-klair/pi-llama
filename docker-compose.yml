services:
  gateway:
    image: nginx:alpine
    ports:
      - "3080:80"
    volumes:
      - ./configs/nginx-gateway.conf:/etc/nginx/nginx.conf:ro
      - ./client/.output/public:/static:ro
    depends_on:
      llama-server:
        condition: service_healthy
      memory-api:
        condition: service_healthy
      whisper:
        condition: service_healthy
      tts:
        condition: service_healthy

  llama-server:
    image: ghcr.io/ggml-org/llama.cpp:server
    volumes:
      - ./models:/models:ro
    command: >
      --model /models/${MODEL_NAME:-Qwen3-4B-Q4_K_M.gguf}
      --host 0.0.0.0
      --port 5000
      -c ${CONTEXT_SIZE:-8192}
      --embedding
      --jinja
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  memory-api:
    build: ./memory-api
    volumes:
      - memory-data:/app/data
    environment:
      - LLAMA_SERVER_URL=http://llama-server:5000
      - DATA_DIR=/app/data
    depends_on:
      llama-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:4000/health')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Speech-to-Text (Whisper) - CPU optimized
  whisper:
    image: onerahmet/openai-whisper-asr-webservice:latest
    volumes:
      - whisper-cache:/root/.cache
    environment:
      - ASR_MODEL=small
      - ASR_ENGINE=faster_whisper
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:9000/')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

  # Text-to-Speech (Piper) - CPU optimized
  tts:
    image: ghcr.io/matatonic/openedai-speech-min
    volumes:
      - tts-voices:/app/voices
      - tts-config:/app/config
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

volumes:
  memory-data:
  whisper-cache:
  tts-voices:
  tts-config:
